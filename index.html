<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>CPM calculator</title>

<style>
body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    font-family: 'Courier New', monospace;
    text-align: center;
    touch-action: manipulation;
    user-select: none;
}

#totalClicks {
    font-size: 48px;
    font-weight: bold;
    color: #FFD700; 
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #222; 
    padding: 10px 20px;
    border-radius: 10px;
    box-shadow: 0 0 15px #FFD700, 0 0 30px #FFA500;
    letter-spacing: 2px;
    z-index: 1000;
}

#message {
    font-size: 24px;
    color: red;
    cursor: pointer;
    margin-top: 150px;
}
</style>
</head>

<body>

<div id="totalClicks">0</div>
<div id="message">Press SPACE or tap anywhere as fast as possible</div>

<script>
let totalClicksCount = parseInt(localStorage.getItem('totalClicks')) || 0;
let dailyHistory = JSON.parse(localStorage.getItem('dailyHistory') || '{}');

let required = 100; 
let seconds = 0;
const timeLimit = 60;

let started = false;
let timerFinished = false;

const message = document.getElementById('message');
const totalClicksElem = document.getElementById('totalClicks');

function getTodayKey() {
    const now = new Date();
    return now.getUTCFullYear() + '-' + (now.getUTCMonth()+1) + '-' + now.getUTCDate();
}

// --- reset lokalnych kliknięć przy starcie ---
function resetLocalClicks() {
    seconds = 0;
    started = false;
    timerFinished = false;

    const today = getTodayKey();
    if (!dailyHistory[today]) dailyHistory[today] = {clicks: 0, redirects: 0};
    else dailyHistory[today].clicks = 0; // reset dziennych kliknięć

    localStorage.setItem('dailyHistory', JSON.stringify(dailyHistory));

    message.textContent = 'Press SPACE or tap anywhere as fast as possible';
}

// --- aktualizacja pola message ---
function updateMessage() {
    const today = getTodayKey();
    const localClicks = dailyHistory[today].clicks;
    message.textContent = `Clicks: ${localClicks}, Time: ${seconds} / ${timeLimit}s`;
}

// --- timer ---
const timer = setInterval(() => {
    if (!started) return;
    seconds++;
    if (seconds >= timeLimit) {
        seconds = timeLimit;
        clearInterval(timer);
        timerFinished = true;
        const today = getTodayKey();
        const localClicks = dailyHistory[today].clicks;
        message.textContent = `Time's up! Clicks: ${localClicks}`;
        return;
    }
    updateMessage();
}, 1000);

// --- kliknięcia ---
let spacePressed = false;

function clickEvent() {
    if (timerFinished) return;
    started = true;

    // GlobalClicks
    totalClicksCount++;
    totalClicksElem.textContent = `${totalClicksCount}`;
    localStorage.setItem('totalClicks', totalClicksCount);

    // LocalClicks
    const today = getTodayKey();
    if (!dailyHistory[today]) dailyHistory[today] = {clicks: 0, redirects: 0};
    dailyHistory[today].clicks++;
    localStorage.setItem('dailyHistory', JSON.stringify(dailyHistory));

    updateMessage();

    // przekierowanie
    if (dailyHistory[today].clicks >= required) {
        dailyHistory[today].redirects = (dailyHistory[today].redirects || 0) + 1;
        localStorage.setItem('dailyHistory', JSON.stringify(dailyHistory));
        window.open('https://ptoszek.pl', '_blank');
    }
}

// --- obsługa klawiatury ---
document.addEventListener('keydown', (e) => {
    if ((e.code === 'Space' || e.key === ' ' || e.key.toLowerCase() === 'x') && !spacePressed) {
        spacePressed = true;
        clickEvent();
    }
    handleSecretSequence(e.key);
});

document.addEventListener('keyup', (e) => {
    if (e.code === 'Space' || e.key === ' ' || e.key.toLowerCase() === 'x') spacePressed = false;
});

// kliknięcia / tapnięcia
document.addEventListener('pointerdown', clickEvent);

// blokada double-tap zoom
let lastTouch = 0;
document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouch <= 300) e.preventDefault();
    lastTouch = now;
}, { passive: false });

// --- sekretny kod do pobrania historii ---
const secretCode = ['D','O','W','!','@','#'];
let secretIndex = 0;
function handleSecretSequence(key) {
    if (key === secretCode[secretIndex]) {
        secretIndex++;
        if (secretIndex === secretCode.length) {
            const blob = new Blob([JSON.stringify(dailyHistory, null, 2)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'daily_click_history.json';
            a.click();
            secretIndex = 0;
        }
    } else secretIndex = 0;
}

// --- inicjalizacja ---
resetLocalClicks();
totalClicksElem.textContent = `${totalClicksCount}`;

</script>

</body>
</html>
